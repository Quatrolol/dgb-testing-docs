# Схема базы данных DGB Testing

Документация по структуре базы данных проекта DGB Testing.

## Таблицы для тестирования

### tests
Таблица с основной информацией о тестах:
- `id` - идентификатор теста
- `title` - название теста
- `description` - описание теста
- `time_limit` - ограничение времени в минутах (не duration_minutes!)
- `start_date` - дата начала доступности теста
- `end_date` - дата окончания доступности теста
- `is_published` - флаг публикации теста (не is_active!)
- отсутствует поле `passing_score` - проходной балл рассчитывается динамически или имеет значение по умолчанию (50%)

### test_questions
Связь между тестами и вопросами:
- `test_id` - идентификатор теста
- `question_id` - идентификатор вопроса
- `order_num` - порядковый номер вопроса в тесте (не question_order!)
- отсутствует поле `points` - вероятно, баллы назначаются единообразно или хранятся в другой таблице

### questions
Таблица с вопросами:
- `id` - идентификатор вопроса
- `question_text` - текст вопроса (не text!)
- `category_id` - идентификатор категории
- `difficulty` - сложность вопроса (1=easy, 2=medium, 3=hard)
- `explanation` - объяснение к вопросу

### question_options
Варианты ответов для вопросов:
- `id` - идентификатор варианта ответа
- `question_id` - идентификатор вопроса
- `text` - текст варианта ответа
- `is_correct` - флаг правильного ответа

### test_sessions
Сессии прохождения тестов:
- `id` - идентификатор сессии
- `user_id` - идентификатор пользователя
- `test_id` - идентификатор теста
- `started_at` - время начала тестирования
- `updated_at` - время последнего обновления
- `status` - статус сессии (in_progress, completed, etc.)
- уникальное ограничение на `(user_id, test_id)` для активных сессий

### test_results
Результаты прохождения тестов:
- `id` - идентификатор результата
- `test_id` - идентификатор теста
- `user_id` - идентификатор пользователя
- `score` - набранные баллы
- `max_score` - максимально возможные баллы
- `percentage` - процент правильных ответов
- `passed` - флаг успешного прохождения
- `started_at` - время начала тестирования
- `completed_at` - время завершения тестирования (NULL для незавершенных тестов)

### test_answers
Ответы пользователей на вопросы:
- `result_id` - идентификатор результата теста
- `question_id` - идентификатор вопроса
- `user_answer` - ответ пользователя (JSON строка)
- `user_answers` - ответы пользователя в формате JSONB (для множественного выбора)
- `is_correct` - флаг правильности ответа
- `points_earned` - заработанные баллы
- `updated_at` - время последнего обновления

## Важные особенности

1. **Особенности именования полей**:
   - В таблице test_questions порядковый номер вопроса хранится в поле `order_num`, а не `question_order`
   - В таблице questions текст вопроса хранится в поле `question_text`, а не `text`
   - В таблице tests ограничение по времени хранится в поле `time_limit`, а не `duration_minutes`
   - В таблице tests флаг публикации хранится в поле `is_published`, а не `is_active`

2. **Особенности SQL-запросов**:
   - При сортировке по порядку вопросов используйте `ORDER BY tq.order_num`, а не `ORDER BY tq.question_order`
   - При получении текста вопроса используйте `q.question_text`, а не `q.text`
   - При работе с ON CONFLICT важно указывать правильные ограничения и поля для обновления

3. **Защита от ошибок**:
   - Перед выполнением сложных запросов проверяйте существование данных с помощью COUNT()
   - Добавляйте try-catch блоки при обработке данных из базы, особенно при обработке отдельных записей в цикле
   - Используйте проверки на существование данных перед их обработкой